<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Your Calendar & Email - Spot Funnel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-width: 600px;
            width: 100%;
            padding: 40px;
            position: relative;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #14b8a6;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 16px;
        }

        .instructions {
            background: #f0fdfa;
            border-left: 4px solid #14b8a6;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }

        .instructions p {
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #14b8a6;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #14b8a6;
        }

        .provider-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .dropdown-wrapper {
            flex: 1;
        }

        .provider-select {
            width: 100%;
            padding: 12px 16px;
            font-size: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 45px;
        }

        .provider-select:hover {
            border-color: #14b8a6;
        }

        .provider-select:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }

        .connect-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #14b8a6;
            color: white;
            min-width: 120px;
        }

        .connect-btn:hover {
            background: #0d9488;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
        }

        .connect-btn.connected {
            background: #059669;
            pointer-events: none;
        }

        .dashboard-btn-wrapper {
            margin-top: 20px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s ease forwards;
        }

        .dashboard-btn {
            width: 100%;
            padding: 16px;
            background: #0f172a;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 16px;
            display: inline-block;
            transition: background 0.2s;
        }

        .dashboard-btn:hover {
            background: #1e293b;
        }

        /* Success Overlay */
        .success-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 12px;
            text-align: center;
            padding: 20px;
        }

        .success-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease forwards;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .success-overlay h2 {
            color: #059669;
            margin-bottom: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .features {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }

        .feature-list {
            list-style: none;
        }

        .feature-list li {
            color: #666;
            font-size: 14px;
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
        }

        .feature-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #14b8a6;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Success Modal Overlay -->
        <div id="success-overlay" class="success-overlay">
            <div class="success-icon">âœ…</div>
            <h2 id="success-message">Success!</h2>
            <p id="success-subtext">Your account has been linked.</p>
        </div>

        <div class="logo">
            <h1>Spot Funnel</h1>
            <p>Connect Your Calendar & Email</p>
        </div>

        <div class="instructions">
            <p><strong>Quick Setup:</strong> Please click the relevant account info button below to authorize Spot
                Funnel to access your calendar and email. This allows our Voice AI to automatically book appointments
                and send customer emails on your behalf.</p>
        </div>

        <!-- EMAIL SECTION -->
        <div class="section">
            <div class="section-title">ðŸ“§ Email Connection</div>
            <div class="provider-group">
                <div class="dropdown-wrapper">
                    <select id="email-provider" class="provider-select">
                        <option value="">Select your email provider</option>
                        <option value="google">Google (Gmail)</option>
                        <option value="microsoft">Microsoft (Outlook)</option>
                        <option value="apple">Apple (iCloud Mail)</option>
                    </select>
                </div>
                <button id="email-connect-btn" class="connect-btn">Connect</button>
            </div>
        </div>

        <!-- CALENDAR SECTION -->
        <div class="section">
            <div class="section-title">ðŸ“… Calendar Connection</div>
            <div class="provider-group">
                <div class="dropdown-wrapper">
                    <select id="calendar-provider" class="provider-select">
                        <option value="">Select your calendar provider</option>
                        <option value="google">Google Calendar</option>
                        <option value="microsoft">Microsoft Outlook Calendar</option>
                        <option value="apple">Apple Calendar (iCloud)</option>
                    </select>
                </div>
                <button id="calendar-connect-btn" class="connect-btn">Connect</button>
            </div>
        </div>

        <!-- Final Finish Button -->
        <div id="dashboard-btn-wrapper" class="dashboard-btn-wrapper">
            <a href="#" class="dashboard-btn" onclick="location.reload(); return false;">All Done! Connections Complete âœ“</a>
        </div>

        <div class="features">
            <ul class="feature-list">
                <li>Check your calendar for availability</li>
                <li>Book appointments into your calendar</li>
                <li>Send emails on your behalf</li>
            </ul>
        </div>
    </div>

    <script>
        const CONFIG = {
            googleClientId: '795418246463-bfh03g04tkgpletq92dj5n541qaeconf.apps.googleusercontent.com',
            googleRedirectUri: 'https://spotfunnel.app.n8n.cloud/webhook/google-oauth-callback',
            microsoftClientId: '146d112c-4201-4d94-9472-f96f6edd4198',
            microsoftRedirectUri: 'https://spotfunnel.app.n8n.cloud/webhook/microsoft-oauth-callback'
        };

        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const service = urlParams.get('service');
        const type = urlParams.get('type');

        // Handle Success Arrival
        if (success === 'true' && service && type) {
            const connectedServices = JSON.parse(localStorage.getItem('spotfunnel_connected') || '{}');
            connectedServices[`${service}-${type}`] = { connected: true, timestamp: new Date().toISOString() };
            localStorage.setItem('spotfunnel_connected', JSON.stringify(connectedServices));

            // Show Success Overlay
            const overlay = document.getElementById('success-overlay');
            const msg = document.getElementById('success-message');
            const sub = document.getElementById('success-subtext');

            msg.textContent = `${service.charAt(0).toUpperCase() + service.slice(1)} ${type.charAt(0).toUpperCase() + type.slice(1)} Connected!`;
            sub.textContent = "Your account is now linked. You can continue or finish below.";
            overlay.classList.add('active');

            // Remove it after 3 seconds
            setTimeout(() => {
                overlay.classList.remove('active');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                updateUI();
            }, 3000);
        }

        function isConnected(type) {
            const connectedServices = JSON.parse(localStorage.getItem('spotfunnel_connected') || '{}');
            return Object.keys(connectedServices).some(key => key.endsWith(`-${type}`) && connectedServices[key].connected);
        }

        function updateUI() {
            const emailConnected = isConnected('email');
            const calendarConnected = isConnected('calendar');

            if (emailConnected) {
                const btn = document.getElementById('email-connect-btn');
                btn.textContent = 'Connected âœ“';
                btn.classList.add('connected');
                btn.disabled = true;
            }

            if (calendarConnected) {
                const btn = document.getElementById('calendar-connect-btn');
                btn.textContent = 'Connected âœ“';
                btn.classList.add('connected');
                btn.disabled = true;
            }

            if (emailConnected && calendarConnected) {
                document.getElementById('dashboard-btn-wrapper').style.display = 'block';
            }
        }

        updateUI();

        document.getElementById('email-connect-btn').addEventListener('click', () => handleConnect('email'));
        document.getElementById('calendar-connect-btn').addEventListener('click', () => handleConnect('calendar'));

        function handleConnect(type) {
            const provider = document.getElementById(`${type}-provider`).value;
            if (!provider) { alert(`Select a ${type} provider`); return; }

            const state = JSON.stringify({ type, provider });
            const scopes = provider === 'google'
                ? ['openid', 'https://www.googleapis.com/auth/userinfo.email', 'https://www.googleapis.com/auth/userinfo.profile', type === 'email' ? 'https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/gmail.readonly' : 'https://www.googleapis.com/auth/calendar']
                : ['openid', 'profile', 'email', 'User.Read', 'offline_access', type === 'email' ? 'https://graph.microsoft.com/Mail.Send https://graph.microsoft.com/Mail.Read' : 'https://graph.microsoft.com/Calendars.ReadWrite'];

            if (provider === 'google') {
                window.location.href = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CONFIG.googleClientId}&redirect_uri=${CONFIG.googleRedirectUri}&response_type=code&scope=${scopes.join(' ')}&access_type=offline&prompt=consent&state=${state}`;
            } else if (provider === 'microsoft') {
                window.location.href = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${CONFIG.microsoftClientId}&redirect_uri=${CONFIG.microsoftRedirectUri}&response_type=code&scope=${scopes.join(' ')}&response_mode=query&state=${state}`;
            } else {
                window.location.href = `apple-setup.html?type=${type}`;
            }
        }
    </script>
</body>
</html>
